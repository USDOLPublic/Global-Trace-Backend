import { BaseMigration } from '@diginexhk/typeorm-helper';
import format from 'pg-format';
import { QueryRunner } from 'typeorm';
import category from '~taxonomy-exploitations/databases/data/taxonomy-exploitation-category-09-08-2023.json';
import riskSeverities from '~taxonomy-exploitations/databases/data/taxonomy-exploitation-risk-severity-09-08-2023.json';

export class UpdateCategoryAndRiskSeverityTableCategory1694160635518 extends BaseMigration {
    async run(queryRunner: QueryRunner) {
        await this.updateCategory(queryRunner);
        await this.updateRiskSeverity(queryRunner);
    }

    async updateCategory(queryRunner: QueryRunner) {
        const sql = format(
            `
            UPDATE "Category"
            SET "category" = 'Labor'
            WHERE "name" IN (%L);

            UPDATE "Category"
            SET "category" = 'Product'
            WHERE "name" IN (%L);
            `,
            category.Labor,
            category.Product
        );

        await queryRunner.query(sql);
    }

    async updateRiskSeverity(queryRunner: QueryRunner) {
        riskSeverities.forEach(async ({ name, riskSeverity }) => {
            const sql = format(
                `
                    UPDATE "Category"
                    SET "riskSeverity" = %s
                    WHERE "name" = %L AND "parentId" IS NOT NULL;
                    `,
                riskSeverity,
                name
            );

            await queryRunner.query(sql);
        });
    }
}
